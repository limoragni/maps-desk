<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <link rel="stylesheet" href="css/main.css">

        <script type="text/javascript">
        	window.$ = window.jQuery = require('./bower_components/jquery/dist/jquery.js');
        </script>
        <script type="text/javascript" src="bower_components/d3/d3.js"></script>
        <script type="text/javascript" src="data/worldMap.js"></script>
        <title></title>
    </head>
    <body>
        <div id="country-indicator"><h1 id="h-country"></h1></div>
        <div id="pointero"><h3>Points: </h3></div>
        <div id="popup"></div>
        <div id="popup2"></div>
        <div id="reset"><h4>Reset</h4></div>
    </body>
    <script type="text/javascript">
    	$(document).ready(function(){
            
            var countClicks = 0;
            var points = 0;
            var wrongPoints = 0;
            var countryKeyArr = Object.keys(WorldMap.names);
            var countryRandomKeyArr = countryKeyArr.slice().mix();
            
            var firstCountry = WorldMap.names[countryRandomKeyArr[0]];
            var countryClick = null

            Array.prototype.mix = function () {
                var n = this.length;
                while (n--) {
                        var i = Math.floor(n * Math.random());
                        var tmp = this[i];
                        this[i] = this[n];
                        this[n] = tmp;
                }
                return this;
            }

            var Game = function(){
                this.countClicks = 0
                this.points = 0
            }

            Game.prototype.onCountryGuessed = function(){
                this
            }

            var game = new Game
            var onCountryClicked = function(data){
                countryClick = WorldMap.names[data.key];
                    //console.log(countryClick);
                if (!isThisTheRightCountry()){
                    onWrongCountry();
                } else  {
                    onGuessedCountry();
                };
                
                if ((countryRandomKeyArr.length === 1 && countClicks === 3)||(countryRandomKeyArr.length === 1 && countryClick === firstCountry)) {
                    var percent = points * 100 / countryKeyArr.length;
                    $('#popup2').append('<p style="margin-top:40px;">Has acertado el '+percent.toFixed(2)+'% de los paises</p>');
                    $('#popup2, #reset').fadeIn();
                    $('#reset').click(function() {
                        countClicks = 0;
                        points = 0;
                        wrongPoints = 0;
                        countryRandomKeyArr = countryKeyArr.slice();
                        countryRandomKeyArr.mix();
                        firstCountry = WorldMap.names[countryRandomKeyArr[0]];
                        $("#h-country").empty();
                        $('#h-country').append(firstCountry);
                        $('#popup2').empty();
                        $('#popup2, #reset').fadeOut();
                        d3.selectAll('path').classed('ctry-fine ctry-wrong',false);
                        $('#pointero').empty();
                        $('#pointero').append("<h3>Points:</h3>");
                        });
                };
            };

            var onGuessedCountry = function(){
                $('#popup').html("<h3>Bravo!!</h3>");
                    $("#popup").fadeIn();
                    $('#pointero').empty();
                    points++;
                    $('#pointero').append("<h3>Points:"+ points + "</h3>");
                    setTimeout(function(){
                    $('#popup').fadeOut();
                    countryRandomKeyArr = countryRandomKeyArr.splice(1,countryRandomKeyArr.length);
                    $("#h-country").empty();
                    firstCountry = WorldMap.names[countryRandomKeyArr[0]];
                    $('#h-country').append(firstCountry);
                    countClicks = 0;

                    },1000);
                    d3.select(this).classed('ctry-fine',true);
            }

            var onWrongCountry = function(){
                showPopup('Nooooo', 'popup');
                setTimeout(function(){
                    $('#popup').fadeOut();
                    if(countClicks === 3){
                        d3.selectAll('path').each(function(d){
                            if (countryRandomKeyArr[0] === d.key) {
                                d3.select(this).classed('ctry-wrong',true);
                            }
                        })
                        countryRandomKeyArr = countryRandomKeyArr.splice(1,countryRandomKeyArr.length);
                        $("#h-country").empty();
                        firstCountry = WorldMap.names[countryRandomKeyArr[0]];
                        $('#h-country').append(firstCountry);
                        countClicks = 0;
                        wrongPoints++
                            //console.log(countryKeyArr.length);

                        };
                    },1000);
                    countClicks++;
            }
            var isThisTheRightCountry = function(){
                if(countryClick === firstCountry)
                    return true
                if(countClicks < 3 && countryClick != firstCountry)
                    return false
            }

            var showPopup = function(content){
                var popup = $('<div class="popup"></div>')
                $('body').append(popup);
                popup.html(content);
                popup.fadeIn();
                return popup;
            }

            showPopup('HOLA').addClass('customPopup')
    		d3.select('body')
                .append('svg')
                .attr('width', '100%')
                .attr('height', '100%')
                .selectAll('path')
                .data(d3.entries(WorldMap.shapes))
                .enter()
                .append('path')
                .attr('d', function(data){return data.value})
                .classed('country', true)
                .on('mouseover', function(d){
                    $(this).attr('fill', '#FF2233')
                })
                .on('mouseout', function(){
                    $(this).attr('fill', '#000000')
                }).
                on('click', onCountryClicked);
                

                //d3.selectAll('path').each(function(d){console.log(d)})
                
                $('#h-country').append(firstCountry);
                //console.log(countryRandomKeyArr);
                //console.log(countryKeyArr);
                
               
                
    	});
    </script>
</html>

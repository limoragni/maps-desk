<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.css">
        <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap-theme.css">

        <link rel="stylesheet" href="css/main.css">

        <script type="text/javascript">
        	window.$ = window.jQuery = require('./bower_components/jquery/dist/jquery.js');
        </script>
        <script type="text/javascript" src="bower_components/bootstrap/dist/js/bootstrap.js"></script>
        <script type="text/javascript" src="bower_components/underscore/underscore.js"></script>
        <script type="text/javascript" src="bower_components/d3/d3.js"></script>
        <script type="text/javascript" src="data/worldMap.js"></script>
        <title></title>
    </head>
    <body>
        <div id="country-indicator"><h1 id="h-country"></h1></div>
        <div id="pointero"><h3>Points: </h3></div>
    </body>
    <script type="text/javascript">
    	$(document).ready(function(){
            Array.prototype.mix = function () {
                var n = this.length;
                while (n--) {
                        var i = Math.floor(n * Math.random());
                        var tmp = this[i];
                        this[i] = this[n];
                        this[n] = tmp;
                }
                return this;
            }

            var Map = function(shapes, selector){
                this.messages = {};
                this.shapes = shapes;
                this.container = this.setContainer(selector);
                this.drawMap();

            }

            Map.prototype.on = function(message, fn){
                if(!this.messages[message]){
                    this.messages[message] = [];
                }
                this.messages[message].push(fn);
            }

            Map.prototype.trigger = function(message, parameter){
                for(var index in this.messages[message]){
                    this.messages[message][index](parameter)
                }
            }

            Map.prototype.setContainer = function(selector){
                return d3.select(selector)
                    .append('svg')
                    .attr('width', '100%')
                    .attr('height', '100%')
            }

            Map.prototype.drawMap = function(){
                var self = this;
                this.container.selectAll('path')
                    .data(d3.entries(this.shapes))
                    .enter()
                    .append('path')
                    .attr('d', function(data){return data.value})
                    .classed('country', true)
                    .on('mouseover', function(){
                        $(this).attr('fill', '#FF2233')
                    })
                    .on('mouseout', function(){
                        $(this).attr('fill', '#000000')
                    })
                    .on('click', function(d){
                        self.trigger('countryClicked', {data: d, country: this});
                    });
            }

            var Game = function(){
                this.countClicks = 0;
                this.points = 0;
                this.wrongPoints = 0;
                this.countryKeyArr = Object.keys(WorldMap.names);
                this.countryRandomKeyArr = this.countryKeyArr.slice().mix();

                this.firstCountry = WorldMap.names[this.countryRandomKeyArr[0]];
                this.countryClick = null
            }

            Game.prototype.onCountryClicked = function(options){
                this.countryClick = WorldMap.names[options.data.key];
                if (!this.isThisTheRightCountry()){
                    this.onWrongCountry();
                } else  {
                    this.onGuessedCountry(options.country);
                };

                if (this.itThisTheLastCountry()) {
                    this.resetCountrys();
                };
            }

            Game.prototype.isThisTheRightCountry = function(){
                if(this.countryClick === this.firstCountry)
                    return true
                if(this.countClicks < 3 && this.countryClick != this.firstCountry)
                    return false
            }

            Game.prototype.onGuessedCountry = function(){
                showPopup('<h1 style="color:green;">OK</h1>');
                setPoints();
                d3.select(country).classed('ctry-fine',true);
                setTimeout(function(){
                    $('div[class="popup"]').fadeOut(function(){
                        this.remove();
                    });
                    deleteFirstCountryShowNext();
                },1000);
            }

            Game.prototype.onWrongCountry = function(){
                showPopup('<h1 style="color:red;">X</h1>');
                $('div[class="popup"]').fadeOut(1000,function(){
                    this.remove();
                });
                if(countClicks === 3){
                    colorWrongCountry();
                    deleteFirstCountryShowNext();
                    wrongPoints++
                    };
                countClicks++;
            }

            Game.prototype.itThisTheLastCountry = function(){
                if ((countryRandomKeyArr.length === 1 && countClicks === 3)||(countryRandomKeyArr.length === 1 && countryClick === firstCountry)) {
                    return true;
                };
            }

            Game.prototype.showPopup = function(content){
                var popup = $('<div class="popup"></div>')
                $('body').append(popup);
                popup.html(content);
                popup.fadeIn();
                return popup;
            }

            Game.prototype.colorWrongCountry = function(){
                d3.selectAll('path').each(function(d){
                    if (countryRandomKeyArr[0] === d.key) {
                        d3.select(this).classed('ctry-wrong',true);
                    }
                })
            }

            Game.prototype.deleteFirstCountryShowNext = function(){
                        countryRandomKeyArr = countryRandomKeyArr.splice(1,countryRandomKeyArr.length);
                        $("#h-country").empty();
                        firstCountry = WorldMap.names[countryRandomKeyArr[0]];
                        $('#h-country').append(firstCountry);
                        countClicks = 0;
            }

            Game.prototype.setPoints = function(){
                $('#pointero').empty();
                points++;
                $('#pointero').append("<h3>Points:"+ points + "</h3>");
            }

            Game.prototype.resetCountrys = function(){
                var percent = points * 100 / countryKeyArr.length;
                    showPopup('<p style="margin-top:40px;">Has acertado el '+percent.toFixed(2)+'% de los paises</p>').addClass('popup2');
                    showPopup('<h4>Reset</h4>').addClass('reset');
                    $('.reset').click(function() {
                        countClicks = 0;
                        points = 0;
                        wrongPoints = 0;
                        countryRandomKeyArr = countryKeyArr.slice().mix();
                        firstCountry = WorldMap.names[countryRandomKeyArr[0]];
                        $("#h-country").empty();
                        $('#h-country').append(firstCountry);
                        $('.popup').fadeOut();
                        d3.selectAll('path').classed('ctry-fine ctry-wrong',false);
                        $('#pointero').empty();
                        $('#pointero').append("<h3>Points:</h3>");
                        });
            }
            // var countClicks = 0;
            // var points = 0;
            // var wrongPoints = 0;
            // var countryKeyArr = Object.keys(WorldMap.names);
            // var countryRandomKeyArr = countryKeyArr.slice().mix();

            // var firstCountry = WorldMap.names[countryRandomKeyArr[0]];
            // var countryClick = null

            // var onCountryClicked = function(data){
            //     countryClick = WorldMap.names[data.key];
            //     if (!isThisTheRightCountry()){
            //         onWrongCountry();
            //     } else  {
            //         onGuessedCountry(this);
            //     };

            //     if (itThisTheLastCountry()) {
            //         resetCountrys();
            //     };
            // };

            // var onGuessedCountry = function(country){
            //     showPopup('<h1 style="color:green;">OK</h1>');
            //     setPoints();
            //     d3.select(country).classed('ctry-fine',true);
            //     setTimeout(function(){
            //         $('div[class="popup"]').fadeOut(function(){
            //             this.remove();
            //         });
            //         deleteFirstCountryShowNext();
            //     },1000);

            //     console.log($('this'));
            // }

            // var onWrongCountry = function(){
            //     showPopup('<h1 style="color:red;">X</h1>');
            //     $('div[class="popup"]').fadeOut(1000,function(){
            //         this.remove();
            //     });
            //     if(countClicks === 3){
            //         colorWrongCountry();
            //         deleteFirstCountryShowNext();
            //         wrongPoints++
            //         };
            //     countClicks++;
            // }

            // var isThisTheRightCountry = function(){
            //     if(countryClick === firstCountry)
            //         return true
            //     if(countClicks < 3 && countryClick != firstCountry)
            //         return false
            // }

            // var itThisTheLastCountry = function(){
            //     if ((countryRandomKeyArr.length === 1 && countClicks === 3)||(countryRandomKeyArr.length === 1 && countryClick === firstCountry)) {
            //         return true;
            //     };
            // }

            // var showPopup = function(content){
            //     var popup = $('<div class="popup"></div>')
            //     $('body').append(popup);
            //     popup.html(content);
            //     popup.fadeIn();
            //     return popup;
            // }

            // var colorWrongCountry = function(){
            //     d3.selectAll('path').each(function(d){
            //         if (countryRandomKeyArr[0] === d.key) {
            //             d3.select(this).classed('ctry-wrong',true);
            //         }
            //     })
            // }

            // var deleteFirstCountryShowNext = function(){
            //             countryRandomKeyArr = countryRandomKeyArr.splice(1,countryRandomKeyArr.length);
            //             $("#h-country").empty();
            //             firstCountry = WorldMap.names[countryRandomKeyArr[0]];
            //             $('#h-country').append(firstCountry);
            //             countClicks = 0;
            // }

            // var setPoints = function(){
            //     $('#pointero').empty();
            //     points++;
            //     $('#pointero').append("<h3>Points:"+ points + "</h3>");
            // }

            // var resetCountrys = function(){
            //     var percent = points * 100 / countryKeyArr.length;
            //         showPopup('<p style="margin-top:40px;">Has acertado el '+percent.toFixed(2)+'% de los paises</p>').addClass('popup2');
            //         showPopup('<h4>Reset</h4>').addClass('reset');
            //         $('.reset').click(function() {
            //             countClicks = 0;
            //             points = 0;
            //             wrongPoints = 0;
            //             countryRandomKeyArr = countryKeyArr.slice().mix();
            //             firstCountry = WorldMap.names[countryRandomKeyArr[0]];
            //             $("#h-country").empty();
            //             $('#h-country').append(firstCountry);
            //             $('.popup').fadeOut();
            //             d3.selectAll('path').classed('ctry-fine ctry-wrong',false);
            //             $('#pointero').empty();
            //             $('#pointero').append("<h3>Points:</h3>");
            //             });
            // }

            //showPopup('HOLA').addClass('customPopup')


            var map = new Map(WorldMap.shapes, 'body');
            var game = new Game();
            map.on('countryClicked', game.onCountryClicked);
            //map.on('countryClicked', onCountryClicked);


            $('#h-country').append(game.firstCountry);

        });
    </script>
</html>
